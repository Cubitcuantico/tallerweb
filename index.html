<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Taller Web</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Bienvenido al Sistema de Taller</h1>
    <div id="auth-section">
      <h2>Iniciar Sesión</h2>
      <input type="email" id="email" placeholder="Correo electrónico">
      <input type="password" id="password" placeholder="Contraseña">
      <button onclick="signIn()">Iniciar Sesión</button>
      <p id="auth-message"></p>
    </div>
    <div id="app-section" style="display: none;">
      <h2>Área de Gestión</h2>
      <button onclick="signOut()">Cerrar Sesión</button>
      <div class="tabs">
        <button class="tab-button" onclick="openTab('new-client')">Nuevo Cliente</button>
        <button class="tab-button" onclick="openTab('work-register')">Registro de Trabajo</button>
        <button class="tab-button" onclick="openTab('inventory')">Inventario</button>
        <button class="tab-button" onclick="openTab('saved-works')">Trabajos Guardados</button>
        <button class="tab-button" onclick="openTab('finances')">Finanzas</button>
      </div>
      <div id="new-client" class="tab-content">
        <h3>Ingresar Cliente</h3>
        <form id="client-form">
          <input type="text" id="client-name" placeholder="Nombre del cliente" required>
          <input type="tel" id="client-phone" placeholder="Número telefónico" required>
          <input type="text" id="client-plates" placeholder="Placas del carro" required>
          <input type="text" id="client-model" placeholder="Modelo del carro" required>
          <input type="number" id="client-year" placeholder="Año del carro" required>
          <button type="submit">Guardar Cliente</button>
        </form>
        <p id="client-message"></p>
      </div>
      <div id="work-register" class="tab-content">
        <h3>Registro de Trabajo</h3>
        <form id="work-form">
          <input type="text" id="client-search" placeholder="Buscar cliente (nombre, teléfono, placas)" required>
          <div id="search-results" style="max-height: 150px; overflow-y: auto;"></div>
          <input type="text" id="work-date" placeholder="Fecha (YYYY-MM-DD)" required>
          <textarea id="work-description" placeholder="Descripción del servicio (ej. Reparación de elevador)" required></textarea>
          <select id="work-worker" required>
            <option value="" disabled selected>Selecciona trabajador</option>
            <option value="Trabajador 1">Trabajador 1</option>
            <option value="Trabajador 2">Trabajador 2</option>
          </select>
          <div id="used-parts-section">
            <h4>Piezas Utilizadas</h4>
            <input type="text" id="work-part-search" placeholder="Buscar pieza (por modelo o nombre)">
            <div id="part-results" style="max-height: 150px; overflow-y: auto;"></div>
            <button type="button" onclick="addUsedPart()">Agregar Pieza Utilizada</button>
            <div id="used-parts-list"></div>
          </div>
          <input type="file" id="work-photo" accept="image/*" style="display:none">
<div id="work-photo-preview"></div>
<button type="button" id="add-photo-btn">Agregar otra foto</button>
         <input type="number" id="work-price" placeholder="Precio" required min="0" step="0.01">
<div>
  <label for="work-payment-method">Método de pago:</label>
  <select id="work-payment-method" name="work-payment-method" required>
    <option value="cash">Efectivo</option>
    <option value="card">Transferencia/Tarjeta</option>
  </select>
</div>
<select id="work-warranty" required>
  <option value="" disabled selected>Selecciona garantía</option>
  <option value="0 días">0 días</option>
  <option value="1 mes">1 mes</option>
</select>
<button type="submit" id="save-work-btn">Guardar Trabajo</button>
        </form>
        <p id="work-message"></p>
      </div>
      <div id="inventory" class="tab-content">
        <h3>Inventario</h3>
        <form id="inventory-form">
          <input type="text" id="part-name" placeholder="Nombre de la pieza (ej. Engrane)" required>
          <input type="text" id="part-model" placeholder="Modelo del carro (ej. Mazda)" required>
          <input type="number" id="part-quantity" placeholder="Cantidad" required min="1">
          <input type="number" id="part-buy-price" placeholder="Precio de compra por pieza" required min="0" step="0.01">
          <input type="number" id="part-sell-price" placeholder="Precio de venta por pieza" required min="0" step="0.01">
          <input type="file" id="part-photo" accept="image/*" onchange="previewPhoto()">
          <div id="photo-preview"></div>
          <button type="submit">Agregar Pieza</button>
        </form>
        <input type="text" id="search-inventory" placeholder="Buscar pieza (nombre o modelo)">
        <div id="inventory-list" style="max-height: 300px; overflow-y: auto;"></div>
        <p id="inventory-message"></p>
      </div>
      <div id="saved-works" class="tab-content">
        <h3>Trabajos Guardados</h3>
        <input type="text" id="saved-client-search" placeholder="Buscar cliente (nombre, teléfono, placas)" required>
        <div id="saved-client-results" style="max-height: 150px; overflow-y: auto;"></div>
        <div id="works-list" style="max-height: 300px; overflow-y: auto;"></div>
        <p id="saved-works-message"></p>
      </div>
      <div id="finances" class="tab-content">
  <h3>Finanzas</h3>
  <div>
    <h4>Ganancias Diarias (Hoy: <span id="current-date"></span>)</h4>
    <p id="daily-profit">$0.00</p>
  </div>
  <div>
    <h4>Ganancias Mensuales (Mes: <span id="current-month"></span>)</h4>
    <p id="monthly-profit">$0.00</p>
  </div>
  <h4>Gastos Misceláneos (Caja Chica)</h4>
  <form id="misc-expense-form">
    <input type="text" id="expense-description" placeholder="Descripción (ej. Gasolina)" required>
    <input type="number" id="expense-amount" placeholder="Monto" required min="0" step="0.01">
    <input type="date" id="expense-date" required>
    <button type="submit">Agregar Gasto</button>
  </form>
  <p id="misc-expense-message"></p>
  <div id="misc-expenses-list" style="max-height: 300px; overflow-y: auto;"></div>
  <h4>Resumen de Corte de Caja</h4>
  <div class="finance-summary-container">
  <table id="finance-summary">
    <thead>
      <tr>
        <th>Período</th>
        <th>Ingresos</th>
        <th>Gastos Inventario</th>
        <th>Gastos Misceláneos</th>
        <th>Saldo Neto</th>
        <th>Piezas Usadas</th>
        <th>Recomendación</th>
      </tr>
    </thead>
    <tbody>
      <tr id="daily-summary"></tr>
      <tr id="weekly-summary"></tr>
      <tr id="monthly-summary"></tr>
    </tbody>
  </table>
</div>
    </div>
  </div>

  <div id="loader" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(255,255,255,0.7); z-index:9999; justify-content:center; align-items:center;">
    <div style="border:8px solid #f3f3f3; border-top:8px solid #1877f2; border-radius:50%; width:60px; height:60px; animation:spin 1s linear infinite;"></div>
  </div>

  <script>
    // Variables globales
    window.selectedPartId = null;
    window.usedParts = [];
    
    // Funciones globales fuera del módulo
    window.signIn = function () {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          document.getElementById('auth-section').style.display = 'none';
          document.getElementById('app-section').style.display = 'block';
          document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
        })
        .catch(error => {
          document.getElementById('auth-message').innerText = error.message;
        });
    };

    window.signOut = function () {
      signOut(auth)
        .then(() => {
          document.getElementById('auth-section').style.display = 'block';
          document.getElementById('app-section').style.display = 'none';
        })
        .catch(error => {
          document.getElementById('auth-message').innerText = error.message;
        });
    };

    window.openTab = function (tabName) {
      const tabs = document.getElementsByClassName('tab-content');
      for (let i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
      }
      const buttons = document.getElementsByClassName('tab-button');
      for (let i = 0; i < buttons.length; i++) {
        buttons[i].classList.remove('active');
      }
      document.getElementById(tabName).classList.add('active');
      document.querySelector(`button[onclick="openTab('${tabName}')"]`).classList.add('active');
    };

    window.addUsedPart = function () {
      console.log('Antes de agregar, selectedPartId:', window.selectedPartId);
      if (!window.selectedPartId) {
        alert('Por favor selecciona una pieza primero.');
        return;
      }
      const partsRef = ref(database, `inventory/${window.selectedPartId}`);
      onValue(partsRef, (snapshot) => {
        const part = snapshot.val();
        if (part && part.quantity > 0) {
          const quantity = prompt(`Cantidad a usar de ${part.name} (máximo ${part.quantity}):`, 1);
          const qty = parseInt(quantity);
          if (qty > 0 && qty <= part.quantity) {
            if (!window.usedParts) window.usedParts = [];
            const existingPart = window.usedParts.find(p => p.partId === window.selectedPartId);
            if (existingPart) {
              existingPart.quantity += qty;
            } else {
              window.usedParts.push({ partId: window.selectedPartId, name: part.name, model: part.model, quantity: qty });
            }
            updateUsedPartsList();
            window.selectedPartId = null;
            document.getElementById('work-part-search').value = '';
            document.getElementById('part-results').innerHTML = '';
          } else {
            alert('Cantidad inválida o excede el inventario.');
          }
        } else {
          alert('No hay suficiente cantidad de esta pieza en inventario.');
        }
      }, { onlyOnce: true });
    };

    window.removeUsedPart = function (index) {
      if (window.usedParts && window.usedParts.length > index) {
        window.usedParts.splice(index, 1);
        updateUsedPartsList();
      }
    };

    window.updateUsedPartsList = function () {
      const list = document.getElementById('used-parts-list');
      list.innerHTML = '';
      if (window.usedParts) {
        window.usedParts.forEach((part, index) => {
          const div = document.createElement('div');
          div.innerHTML = `${part.name} (${part.model}) - Cantidad: ${part.quantity} <button onclick="removeUsedPart(${index})">Eliminar</button>`;
          list.appendChild(div);
        });
      }
    };

  window.previewWorkPhoto = function () {
  const files = document.getElementById('work-photo').files;
  const previewDiv = document.getElementById('work-photo-preview');
  previewDiv.innerHTML = '';
  for (let i = 0; i < files.length; i++) {
    const reader = new FileReader();
    reader.onload = function (e) {
      const img = document.createElement('img');
      img.src = e.target.result;
      img.style.maxWidth = '200px';
      img.style.margin = '5px';
      previewDiv.appendChild(img);
    };
    reader.readAsDataURL(files[i]);
  }
};

window.previewPhoto = function () {
  const file = document.getElementById('part-photo').files[0];
  const previewDiv = document.getElementById('photo-preview');
  previewDiv.innerHTML = '';
  if (file) {
    const reader = new FileReader();
    reader.onload = function (e) {
      const img = document.createElement('img');
      img.src = e.target.result;
      img.style.maxWidth = '120px';
      img.style.borderRadius = '6px';
      img.style.margin = '8px';
      previewDiv.appendChild(img);
    };
    reader.readAsDataURL(file);
  }
};

window.removePart = async function (partId) {
  if (confirm('¿Estás seguro de eliminar esta pieza?')) {
    const partRef = ref(database, `inventory/${partId}`);
    onValue(partRef, async (snapshot) => {
      const part = snapshot.val();
      if (part) {
        const costToRevert = part.buyPrice * part.quantity;
        const today = new Date(Date.now() - (new Date()).getTimezoneOffset() * 60000).toISOString().split('T')[0];
        const financeRef = ref(database, `finances/${today}`);
        await runTransaction(financeRef, (currentFinance) => {
          const currentProfit = currentFinance?.profit || 0;
          // Revertir el gasto sumando el costo de compra
          return { profit: currentProfit + costToRevert };
        });
        // Opcional: Eliminar el gasto original si lo guardaste en otra fecha
        // await remove(ref(database, `finances/${part.createdAt.split('T')[0]}`));
        await remove(partRef);
        document.getElementById('inventory-message').innerText = 'Pieza eliminada con éxito';
        loadInventory();
        updateFinanceSummary(); // Actualiza el resumen
      } else {
        document.getElementById('inventory-message').innerText = 'Pieza no encontrada.';
      }
    }, { onlyOnce: true });
  }
};

   window.sendWhatsApp = function (workId) {
  const worksRef = ref(database, `works/${workId}`);
  onValue(worksRef, (snapshot) => {
    const work = snapshot.val();
    if (work) {
      const clientsRef = ref(database, `clients/${work.clientId}`);
      onValue(clientsRef, (clientSnapshot) => {
        const client = clientSnapshot.val();
        if (client) {
          const message = 
  `*NOTA DE TRABAJO - TALLER CHINOS HMO*\n\n` +
  `Cliente: ${client.name}\n` +
  `Vehículo: ${client.plates} (${client.model} ${client.year})\n` +
  `Fecha: ${work.date}\n` +
  `Descripción del servicio: ${work.description}\n` +
  `Trabajador responsable: ${work.worker}\n` +
  `Costo: $${work.price}\n` +
  `Garantía: ${work.warranty}\n\n` +
  `Firma: Taller Chinos HMO\n` +
  `Gracias por confiar en nosotros.`;
          const phone = client.phone.replace(/[^0-9]/g, '');
          const whatsappUrl = `https://wa.me/52${phone}?text=${encodeURIComponent(message)}`;
          window.open(whatsappUrl, '_blank');
        }
      }, { onlyOnce: true });
    }
  }, { onlyOnce: true });
};
    function showMessage(id, message, color = 'green') {
      const el = document.getElementById(id);
      el.innerText = message;
      el.style.color = color;
      el.style.fontWeight = 'bold';
      setTimeout(() => {
        el.innerText = '';
        el.style.fontWeight = 'normal';
      }, 3500);
    }
  </script>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, push, set, onValue, runTransaction, remove, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = {
      // Reemplaza con tu configuración real de Firebase
      apiKey: "AIzaSyCG5ygxMUutGfrC1nyKYyM2hGUefC6uqRQ",
  authDomain: "tallerweb-a1f2c.firebaseapp.com",
  databaseURL: "https://tallerweb-a1f2c-default-rtdb.firebaseio.com",
  projectId: "tallerweb-a1f2c",
  storageBucket: "tallerweb-a1f2c.firebasestorage.app",
  messagingSenderId: "836145983688",
  appId: "1:836145983688:web:6b8bf578ae6419bf4ff5fd",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);
    // --- AQUÍ PEGA EL BLOQUE DE GUARDAR GASTOS MISCELÁNEOS ---
document.getElementById('misc-expense-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  const description = document.getElementById('expense-description').value;
  const amount = parseFloat(document.getElementById('expense-amount').value);
  const date = document.getElementById('expense-date').value;

  if (!description || isNaN(amount) || !date) {
    document.getElementById('misc-expense-message').innerText = 'Completa todos los campos.';
    return;
  }

  const expensesRef = ref(database, 'expenses');
  const newExpenseRef = push(expensesRef);

  await set(newExpenseRef, {
    id: newExpenseRef.key,
    description,
    amount,
    date,
    createdAt: new Date().toISOString()
  });

  document.getElementById('misc-expense-message').innerText = 'Gasto agregado con éxito';
  document.getElementById('misc-expense-form').reset();
  document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
  loadMiscExpenses();
});
    // Exponer al ámbito global
    window.auth = auth;
    window.database = database;
    window.ref = ref;
    window.push = push;
    window.set = set;
    window.onValue = onValue;
    window.runTransaction = runTransaction;
    window.remove = remove;
    window.onDisconnect = onDisconnect;
    window.signInWithEmailAndPassword = signInWithEmailAndPassword;
    window.signOut = signOut;

    // Monitorear estado de conexión
    const connectedRef = ref(database, ".info/connected");
    let isConnected = false;
    onValue(connectedRef, (snap) => {
      isConnected = snap.val();
      if (!isConnected) {
        document.getElementById('work-message').innerText = 'Sin conexión a Firebase. Por favor, verifica tu internet.';
      }
    });

    onAuthStateChanged(auth, user => {
      if (user) {
        document.getElementById('auth-section').style.display = 'none';
        document.getElementById('app-section').style.display = 'block';
      } else {
        document.getElementById('auth-section').style.display = 'block';
        document.getElementById('app-section').style.display = 'none';
      }
    });

    document.getElementById('client-form').addEventListener('submit', (e) => {
  e.preventDefault();
  if (!isConnected) {
    document.getElementById('client-message').innerText = 'Sin conexión a Firebase. Por favor, verifica tu internet.';
    return;
  }
  const name = document.getElementById('client-name').value;
  const phone = document.getElementById('client-phone').value;
  const plates = document.getElementById('client-plates').value;
  const model = document.getElementById('client-model').value;
  const year = document.getElementById('client-year').value;

  const clientsRef = ref(database, 'clients');
  const newClientRef = push(clientsRef);

  set(newClientRef, {
    id: newClientRef.key,
    name: name,
    phone: phone,
    plates: plates,
    model: model,
    year: year,
    createdAt: new Date().toISOString()
  })
    .then(() => {
      document.getElementById('client-message').innerText = 'Cliente guardado con éxito';
      document.getElementById('client-form').reset();
    })
    .catch(error => {
      document.getElementById('client-message').innerText = error.message;
    });
});
    let selectedClientId = null;
    document.getElementById('client-search').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const clientsRef = ref(database, 'clients');
      onValue(clientsRef, (snapshot) => {
        const clients = snapshot.val();
        const resultsDiv = document.getElementById('search-results');
        resultsDiv.innerHTML = '';
        if (clients && searchTerm) {
          Object.entries(clients).forEach(([id, client]) => {
            if (
              client.name.toLowerCase().includes(searchTerm) ||
              client.phone.includes(searchTerm) ||
              client.plates.toLowerCase().includes(searchTerm)
            ) {
              const resultItem = document.createElement('div');
              resultItem.classList.add('result-item');
              resultItem.innerText = `${client.name} | ${client.phone} | ${client.plates}`;
              resultItem.onclick = () => {
                selectedClientId = id;
                document.getElementById('client-search').value = client.name;
                resultsDiv.innerHTML = '';
              };
              resultsDiv.appendChild(resultItem);
            }
          });
        }
      });
    });

    document.getElementById('work-date').value = new Date(Date.now() - (new Date()).getTimezoneOffset() * 60000).toISOString().split('T')[0];

    document.getElementById('work-part-search').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const partsRef = ref(database, 'inventory');
      onValue(partsRef, (snapshot) => {
        const parts = snapshot.val();
        const resultsDiv = document.getElementById('part-results');
        resultsDiv.innerHTML = '';
        if (parts && searchTerm) {
          Object.entries(parts).forEach(([id, part]) => {
            const clientModel = document.getElementById('client-search').value.toLowerCase();
            if (
              part.name.toLowerCase().includes(searchTerm) ||
              part.model.toLowerCase().includes(searchTerm) ||
              (clientModel && part.model.toLowerCase().includes(clientModel) && searchTerm)
            ) {
              if (part.quantity > 0) {
                const resultItem = document.createElement('div');
                resultItem.classList.add('result-item');
                resultItem.innerText = `${part.name} (${part.model}) - Cantidad: ${part.quantity}`;
                resultItem.onclick = () => {
                  window.selectedPartId = id;
                  console.log('Pieza seleccionada, ID:', window.selectedPartId);
                  document.getElementById('work-part-search').value = part.name;
                  resultsDiv.innerHTML = '';
                };
                resultsDiv.appendChild(resultItem);
              }
            }
          });
        }
      });
    });

    let isSaving = false;
    async function compressImage(file, maxWidth = 800, quality = 0.7) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const reader = new FileReader();
    reader.onload = function (e) {
      img.src = e.target.result;
      img.onload = function () {
        const canvas = document.createElement('canvas');
        const scale = Math.min(1, maxWidth / img.width);
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(
          (blob) => {
            const reader2 = new FileReader();
            reader2.onloadend = () => {
              resolve(reader2.result.split(',')[1]);
            };
            reader2.onerror = reject;
            reader2.readAsDataURL(blob);
          },
          'image/jpeg',
          quality
        );
      };
      img.onerror = reject;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// --- Manejo de fotos múltiples ---
window.selectedPhotos = [];

document.getElementById('add-photo-btn').onclick = function () {
  document.getElementById('work-photo').click();
};

document.getElementById('work-photo').onchange = function () {
  const files = Array.from(this.files);
  files.forEach(file => {
    window.selectedPhotos.push(file);
  });
  updatePhotoPreview();
  this.value = ''; // Permite volver a seleccionar la misma foto si se elimina
};

window.removePreviewPhoto = function (index) {
  window.selectedPhotos.splice(index, 1);
  updatePhotoPreview();
};

function updatePhotoPreview() {
  const previewDiv = document.getElementById('work-photo-preview');
  previewDiv.innerHTML = '';
  window.selectedPhotos.forEach((file, idx) => {
    const reader = new FileReader();
    reader.onload = function (e) {
      const photoDiv = document.createElement('div');
      photoDiv.style.display = 'inline-block';
      photoDiv.style.position = 'relative';
      photoDiv.style.margin = '5px';
      const img = document.createElement('img');
      img.src = e.target.result;
      img.style.maxWidth = '120px';
      img.style.borderRadius = '6px';
      const removeBtn = document.createElement('button');
      removeBtn.innerText = 'Eliminar';
      removeBtn.style.position = 'absolute';
      removeBtn.style.top = '2px';
      removeBtn.style.right = '2px';
      removeBtn.style.background = '#e74c3c';
      removeBtn.style.color = '#fff';
      removeBtn.style.border = 'none';
      removeBtn.style.borderRadius = '3px';
      removeBtn.style.cursor = 'pointer';
      removeBtn.onclick = function () {
        window.removePreviewPhoto(idx);
      };
      photoDiv.appendChild(img);
      photoDiv.appendChild(removeBtn);
      previewDiv.appendChild(photoDiv);
    };
    reader.readAsDataURL(file);
  });
}
document.getElementById('work-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  if (isSaving) return;
  if (!isConnected) {
    document.getElementById('work-message').innerText = 'Sin conexión a Firebase. Por favor, verifica tu internet.';
    return;
  }

  isSaving = true;
  const saveButton = document.getElementById('save-work-btn');
  saveButton.disabled = true;
  document.getElementById('work-message').innerText = 'Guardando...';

  if (!selectedClientId) {
    document.getElementById('work-message').innerText = 'Por favor selecciona un cliente';
    isSaving = false;
    saveButton.disabled = false;
    return;
  }

  const date = document.getElementById('work-date').value;
  const description = document.getElementById('work-description').value;
  const worker = document.getElementById('work-worker').value;
  const price = parseFloat(document.getElementById('work-price').value);
  const warranty = document.getElementById('work-warranty').value;
  const paymentMethod = document.getElementById('work-payment-method').value;
  const files = window.selectedPhotos || [];
  let photos = [];

  try {
    if (files.length > 0) {
      for (let i = 0; i < files.length; i++) {
        const base64 = await compressImage(files[i], 800, 0.7);
        if (base64.length > 400000) {
          document.getElementById('work-message').innerText = 'Una de las fotos excede el tamaño máximo (300 KB). Usa imágenes más pequeñas.';
          isSaving = false;
          saveButton.disabled = false;
          return;
        }
        photos.push(base64);
      }
    }

    const worksRef = ref(database, 'works');
    const newWorkRef = push(worksRef);

    // Actualizar inventario si hay piezas utilizadas
    if (window.usedParts && window.usedParts.length > 0) {
      for (const usedPart of window.usedParts) {
        const partRef = ref(database, `inventory/${usedPart.partId}`);
        await runTransaction(partRef, (part) => {
          if (part && part.quantity >= usedPart.quantity) {
            part.quantity -= usedPart.quantity;
            return part;
          } else {
            throw new Error(`No hay suficiente cantidad de "${usedPart.name} (${usedPart.model})" en inventario. Intentaste usar ${usedPart.quantity}, pero solo hay ${part?.quantity || 0} disponible(s).`);
          }
        });
      }
    }

    // Guardar el trabajo con todas las propiedades
    await set(newWorkRef, {
      id: newWorkRef.key,
      clientId: selectedClientId,
      date: date,
      description: description,
      worker: worker,
      price: price,
      warranty: warranty,
      paymentMethod: paymentMethod,
      usedParts: window.usedParts || [],
      photos: photos,
      createdAt: new Date().toISOString()
    });
   
    // Actualizar finanzas
    const financeRef = ref(database, `finances/${date}`);
    await runTransaction(financeRef, (currentFinance) => {
      const currentProfit = currentFinance?.profit || 0;
      return { profit: currentProfit + price };
    });

    document.getElementById('work-message').innerText = 'Trabajo guardado con éxito';
    document.getElementById('work-form').reset();
    document.getElementById('work-date').value = new Date().toISOString().split('T')[0];
    window.usedParts = [];
    updateUsedPartsList();
    document.getElementById('work-photo-preview').innerHTML = '';
    selectedClientId = null;
  } catch (error) {
    document.getElementById('work-message').innerText = `Error al guardar el trabajo: ${error.message}`;
  } finally {
    isSaving = false;
    saveButton.disabled = false;
  }
});
    onValue(ref(database, 'works'), (snapshot) => {
      snapshot.forEach((childSnapshot) => {
        const work = childSnapshot.val();
        const workId = childSnapshot.key;
        const deleteButton = document.querySelector(`#delete-work-${workId}`);
        if (deleteButton) {
          deleteButton.onclick = async () => {
            if (confirm('¿Estás seguro de eliminar este trabajo? Esto devolverá las piezas al inventario y ajustará las finanzas.')) {
              try {
                console.log('Intentando eliminar trabajo:', workId);
                for (const usedPart of work.usedParts || []) {
                  const partRef = ref(database, `inventory/${usedPart.partId}`);
                  await runTransaction(partRef, (part) => {
                    if (part) {
                      part.quantity += usedPart.quantity || 0;
                      return part;
                    }
                    return null;
                  });
                }
                const financeRef = ref(database, `finances/${work.date}`);
                await runTransaction(financeRef, (currentFinance) => {
                  const currentProfit = currentFinance?.profit || 0;
                  return { profit: currentProfit - (work.price || 0) };
                });
                await remove(ref(database, `works/${workId}`));
                document.getElementById('work-message').innerText = 'Trabajo eliminado, piezas devueltas y finanzas ajustadas.';
                console.log('Trabajo eliminado exitosamente:', workId);
              } catch (error) {
                console.error('Error al eliminar trabajo:', error);
                document.getElementById('work-message').innerText = `Error al eliminar el trabajo: ${error.message}`;
              }
            }
          };
        }
      });
    });

    document.getElementById('inventory-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!isConnected) {
    document.getElementById('inventory-message').innerText = 'Sin conexión a Firebase. Por favor, verifica tu internet.';
    return;
  }
  const name = document.getElementById('part-name').value;
  const model = document.getElementById('part-model').value;
  const quantity = parseInt(document.getElementById('part-quantity').value);
  const buyPrice = parseFloat(document.getElementById('part-buy-price').value);
  const sellPrice = parseFloat(document.getElementById('part-sell-price').value);
  const file = document.getElementById('part-photo').files[0];
  let photoBase64 = '';

  const partsRef = ref(database, 'inventory');
  let existingPartId = null;
  let existingPart = null;
  await new Promise((resolve) => {
    onValue(partsRef, (snapshot) => {
      const parts = snapshot.val();
      if (parts) {
        Object.entries(parts).forEach(([id, part]) => {
          if (part.name.toLowerCase() === name.toLowerCase() && part.model.toLowerCase() === model.toLowerCase()) {
            existingPartId = id;
            existingPart = part;
          }
        });
      }
      resolve();
    }, { onlyOnce: true });
  });

  if (existingPartId) {
    const partRef = ref(database, `inventory/${existingPartId}`);
    await runTransaction(partRef, (part) => {
      if (part) {
        part.quantity += quantity;
        part.buyPrice = buyPrice;
        part.sellPrice = sellPrice;
        if (file) {
          part.photo = photoBase64;
        }
        return part;
      }
    });

const today = new Date(Date.now() - (new Date()).getTimezoneOffset() * 60000).toISOString().split('T')[0];
    const financeRef = ref(database, `finances/${today}`);
    await runTransaction(financeRef, (currentFinance) => {
      const currentProfit = currentFinance?.profit || 0;
      const additionalCost = buyPrice * quantity;
      return { profit: currentProfit - additionalCost };
    });

    document.getElementById('inventory-message').innerText = 'Pieza actualizada con éxito';
    document.getElementById('inventory-form').reset();
    document.getElementById('photo-preview').innerHTML = '';
    loadInventory();
  } else {
    if (file) {
      const reader = new FileReader();
      reader.onload = async function (e) {
        const img = new Image();
        img.src = e.target.result;

        img.onload = async function () {
          const maxSize = 300 * 1024; // 300 KB en bytes
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');

          // Reducir dimensiones manteniendo la proporción
          let width = img.width;
          let height = img.height;
          const maxWidth = 800; // Límite de ancho
          const maxHeight = 600; // Límite de alto
          if (width > height) {
            if (width > maxWidth) {
              height *= maxWidth / width;
              width = maxWidth;
            }
          } else {
            if (height > maxHeight) {
              width *= maxHeight / height;
              height = maxHeight;
            }
          }

          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);

          // Comprimir la imagen (calidad 0.7, ajustable entre 0 y 1)
          photoBase64 = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
          const byteLength = atob(photoBase64).length;
          if (byteLength > maxSize) {
            document.getElementById('inventory-message').innerText = 'La imagen sigue excediendo 300 KB después de la compresión. Intenta con una imagen más pequeña.';
            return;
          }

          const newPartRef = push(partsRef);

          await set(newPartRef, {
            id: newPartRef.key,
            name: name,
            model: model,
            quantity: quantity,
            buyPrice: buyPrice,
            sellPrice: sellPrice,
            photo: photoBase64,
            createdAt: new Date().toISOString()
          });

          const today = new Date(Date.now() - (new Date()).getTimezoneOffset() * 60000).toISOString().split('T')[0];
          const financeRef = ref(database, `finances/${today}`);
          await runTransaction(financeRef, (currentFinance) => {
            const currentProfit = currentFinance?.profit || 0;
            const cost = buyPrice * quantity;
            return { profit: currentProfit - cost };
          });

          document.getElementById('inventory-message').innerText = 'Pieza agregada con éxito';
          document.getElementById('inventory-form').reset();
          document.getElementById('photo-preview').innerHTML = '';
          loadInventory();
        };

        img.onerror = function () {
          document.getElementById('inventory-message').innerText = 'Error al procesar la imagen.';
        };
      };
      reader.readAsDataURL(file);
    } else {
      const newPartRef = push(partsRef);

      await set(newPartRef, {
        id: newPartRef.key,
        name: name,
        model: model,
        quantity: quantity,
        buyPrice: buyPrice,
        sellPrice: sellPrice,
        photo: '',
        createdAt: new Date().toISOString()
      });

      const today = new Date(Date.now() - (new Date()).getTimezoneOffset() * 60000).toISOString().split('T')[0];
      const financeRef = ref(database, `finances/${today}`);
      await runTransaction(financeRef, (currentFinance) => {
        const currentProfit = currentFinance?.profit || 0;
        const cost = buyPrice * quantity;
        return { profit: currentProfit - cost };
      });

      document.getElementById('inventory-message').innerText = 'Pieza agregada con éxito';
      document.getElementById('inventory-form').reset();
      loadInventory();
    }
  }
});

    let inventoryListener = null;
    function loadInventory() {
      const searchTerm = document.getElementById('search-inventory').value.toLowerCase();
      const inventoryList = document.getElementById('inventory-list');
      inventoryList.innerHTML = '';

      if (inventoryListener) {
        inventoryListener();
      }

      const partsRef = ref(database, 'inventory');
      inventoryListener = onValue(partsRef, (snapshot) => {
        const parts = snapshot.val();
        const displayedParts = new Set();
        inventoryList.innerHTML = '';

        if (parts) {
          Object.entries(parts).forEach(([id, part]) => {
            const partKey = `${part.name.toLowerCase()}-${part.model.toLowerCase()}-${id}`;
            if (
              (part.name.toLowerCase().includes(searchTerm) ||
              part.model.toLowerCase().includes(searchTerm)) &&
              !displayedParts.has(partKey)
            ) {
              displayedParts.add(partKey);
              const div = document.createElement('div');
              div.classList.add('inventory-item');
              div.innerHTML = `
                <span>${part.name} (${part.model}) - Cantidad: ${part.quantity} - Compra: $${part.buyPrice} - Venta: $${part.sellPrice}</span>
                ${part.photo ? `<img src="data:image/jpeg;base64,${part.photo}" style="max-width: 50px;">` : ''}
                <button onclick="editPart('${id}')">Editar</button>
                <button onclick="removePart('${id}')">Eliminar</button>
                ${part.quantity <= 1 ? '<span style="color: red;">¡Pocas piezas!</span>' : ''}
              `;
              inventoryList.appendChild(div);
            }
          });
        }
      });
    }
window.loadInventory = loadInventory;
    let lastSearchTime = 0;
    const debounceDelay = 300;
    document.getElementById('search-inventory').addEventListener('input', () => {
      const now = Date.now();
      if (now - lastSearchTime >= debounceDelay) {
        lastSearchTime = now;
        loadInventory();
      }
    });

    let selectedSavedClientId = null;
    document.getElementById('saved-client-search').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const clientsRef = ref(database, 'clients');
      onValue(clientsRef, (snapshot) => {
        const clients = snapshot.val();
        const resultsDiv = document.getElementById('saved-client-results');
        resultsDiv.innerHTML = '';
        if (clients && searchTerm) {
          Object.entries(clients).forEach(([id, client]) => {
            if (
              client.name.toLowerCase().includes(searchTerm) ||
              client.phone.includes(searchTerm) ||
              client.plates.toLowerCase().includes(searchTerm)
            ) {
              const resultItem = document.createElement('div');
              resultItem.classList.add('result-item');
              resultItem.innerText = `${client.name} | ${client.phone} | ${client.plates}`;
              resultItem.onclick = () => {
                selectedSavedClientId = id;
                document.getElementById('saved-client-search').value = client.name;
                resultsDiv.innerHTML = '';
                loadWorksForClient();
              };
              resultsDiv.appendChild(resultItem);
            }
          });
        } else {
          resultsDiv.innerHTML = '<div>No se encontraron clientes</div>';
        }
      }, { onlyOnce: true });
    });
function loadWorksForClient() {
  const worksList = document.getElementById('works-list');
  worksList.innerHTML = '';
  document.getElementById('saved-works-message').innerText = 'Cargando trabajos...';
  if (!selectedSavedClientId) {
    document.getElementById('saved-works-message').innerText = 'Por favor selecciona un cliente';
    return;
  }

  const worksRef = ref(database, 'works');
  onValue(worksRef, (snapshot) => {
    const works = snapshot.val();
    worksList.innerHTML = '';
    let hasWorks = false;
    if (works) {
      Object.entries(works).forEach(([id, work]) => {
        if (work.clientId === selectedSavedClientId) {
          hasWorks = true;
          const workDate = new Date(work.date);
          const warrantyDays = work.warranty === '1 mes' ? 30 : 0;
          const warrantyEnd = new Date(workDate);
          warrantyEnd.setDate(workDate.getDate() + warrantyDays);
          const isExpired = warrantyEnd < new Date('2025-06-06');
          const div = document.createElement('div');
        div.innerHTML = `
  <p>Fecha: ${work.date} | Descripción: ${work.description} | Trabajador: ${work.worker} | Garantía: ${work.warranty} ${isExpired ? '(Caducada)' : '(Vigente)'}</p>
  ${(work.photos || []).map(photo => `<img src="data:image/jpeg;base64,${photo}" style="max-width: 100px;">`).join('')}
  <button onclick="sendWhatsApp('${id}')">Enviar por WhatsApp</button>
`;
          // Crear y asignar el botón Eliminar Trabajo
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Eliminar Trabajo';
          deleteBtn.onclick = async () => {
            if (confirm('¿Estás seguro de eliminar este trabajo? Esto devolverá las piezas al inventario y ajustará las finanzas.')) {
              try {
                for (const usedPart of work.usedParts || []) {
                  const partRef = ref(database, `inventory/${usedPart.partId}`);
                  await runTransaction(partRef, (part) => {
                    if (part) {
                      part.quantity += usedPart.quantity || 0;
                      return part;
                    }
                    return null;
                  });
                }
                const financeRef = ref(database, `finances/${work.date}`);
                await runTransaction(financeRef, (currentFinance) => {
                  const currentProfit = currentFinance?.profit || 0;
                  return { profit: currentProfit - (work.price || 0) };
                });
                await remove(ref(database, `works/${id}`));
                showMessage('saved-works-message', 'Trabajo eliminado, piezas devueltas y finanzas ajustadas.', 'green');
                loadWorksForClient(); // Actualiza la lista
              } catch (error) {
                showMessage('saved-works-message', `Error al eliminar el trabajo: ${error.message}`, 'red');
              }
            }
          };
          div.appendChild(deleteBtn);
          worksList.appendChild(div);
        }
      });
    }
    if (!hasWorks) {
      document.getElementById('saved-works-message').innerText = 'No hay trabajos para este cliente';
    } else {
      document.getElementById('saved-works-message').innerText = '';
    }
  }, { onlyOnce: true });
}
   
    // Lógica de finanzas en tiempo real

function updateFinances() {
  const now = new Date();
  const today = now.toISOString().split('T')[0];
  const currentMonth = today.substring(0, 7);
  document.getElementById('current-date').innerText = today;
  document.getElementById('current-month').innerText = currentMonth;

  const financesRef = ref(database, 'finances');
  onValue(financesRef, (snapshot) => {
    const finances = snapshot.val();
    let dailyProfit = 0;
    let monthlyProfit = 0;

    if (finances) {
      if (finances[today]) {
        dailyProfit = finances[today].profit || 0;
      }
      Object.keys(finances).forEach((date) => {
        if (date.startsWith(currentMonth)) {
          monthlyProfit += finances[date].profit || 0;
        }
      });
    }

    document.getElementById('daily-profit').innerText = `$${dailyProfit.toFixed(2)}`;
    document.getElementById('monthly-profit').innerText = `$${monthlyProfit.toFixed(2)}`;
  });
}

function updateFinanceSummary() {
  const now = new Date();
  const today = now.toISOString().split('T')[0];
  const weekStart = new Date(now);
  weekStart.setDate(now.getDate() - now.getDay());
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

  const worksRef = ref(database, 'works');
  const financesRef = ref(database, 'finances');
  const expensesRef = ref(database, 'expenses');
  const inventoryRef = ref(database, 'inventory');

  onValue(worksRef, (worksSnapshot) => {
    onValue(financesRef, (financesSnapshot) => {
      onValue(expensesRef, (expensesSnapshot) => {
        onValue(inventoryRef, (inventorySnapshot) => {
          const works = worksSnapshot.val() || {};
          const finances = financesSnapshot.val() || {};
          const expenses = expensesSnapshot.val() || {};
          const inventory = inventorySnapshot.val() || {};

         const calcIncome = (startDate, endDate) => {
  let income = 0;
  Object.values(works).forEach(work => {
    // Compara solo la fecha en formato YYYY-MM-DD
    if (work.date >= startDate && work.date <= endDate) {
      income += work.price || 0;
    }
  });
  return income;
};

const calcInventoryExpenses = (startDate, endDate) => {
  let expense = 0;
  // Gastos por piezas usadas en trabajos
  Object.values(works).forEach(work => {
    if (work.date >= startDate && work.date <= endDate && work.usedParts) {
      work.usedParts.forEach(part => {
        const invPart = inventory[part.partId];
        if (invPart) expense += (invPart.buyPrice || 0) * part.quantity;
      });
    }
  });
  // Gastos por compra de piezas (finances)
  Object.entries(finances).forEach(([date, data]) => {
    if (date >= startDate && date <= endDate && data.profit < 0) {
      expense += Math.abs(data.profit);
    }
  });
  return expense;
};
const calcMiscExpenses = (startDate, endDate) => {
  let expense = 0;
  Object.values(expenses || {}).forEach(exp => {
    if (exp.date >= startDate && exp.date <= endDate) {
      expense += exp.amount || 0;
    }
  });
  return expense;
};

const calcUsedPartsCount = (startDate, endDate) => {
  let count = 0;
  Object.values(works).forEach(work => {
    if (work.date >= startDate && work.date <= endDate && work.usedParts) {
      count += work.usedParts.length;
    }
  });
  return count;
};

          const updateRow = (id, startDate, endDate) => {
            const income = calcIncome(startDate, endDate);
            const invExpense = calcInventoryExpenses(startDate, endDate);
            const miscExpense = calcMiscExpenses(startDate, endDate);
            const netBalance = income - invExpense - miscExpense;
            const usedPartsCount = calcUsedPartsCount(startDate, endDate);

            const row = document.getElementById(id);
            row.innerHTML = `
              <td>${id === 'daily-summary' ? 'Diario' : id === 'weekly-summary' ? 'Semanal' : 'Mensual'}</td>
              <td>$${income.toFixed(2)}</td>
              <td>$${invExpense.toFixed(2)}</td>
              <td>$${miscExpense.toFixed(2)}</td>
              <td>$${netBalance.toFixed(2)}</td>
              <td>${usedPartsCount} piezas</td>
              <td>${netBalance > 0 ? 'Posible reinversión' : 'Revisar gastos'}</td>
            `;
          };

const todayStr = now.toISOString().split('T')[0];
const weekStartStr = weekStart.toISOString().split('T')[0];
const monthStartStr = monthStart.toISOString().split('T')[0];

updateRow('daily-summary', todayStr, todayStr);
updateRow('weekly-summary', weekStartStr, todayStr);
updateRow('monthly-summary', monthStartStr, todayStr);

        });
      });
    });
  });
}
window.updateFinanceSummary = updateFinanceSummary;
function loadMiscExpenses() {
  const expensesList = document.getElementById('misc-expenses-list');
  expensesList.innerHTML = '';
  const expensesRef = ref(database, 'expenses');
  onValue(expensesRef, (snapshot) => {
    const expenses = snapshot.val();
    if (expenses) {
      // Ordenar por fecha descendente
      const sorted = Object.values(expenses).sort((a, b) => new Date(b.date) - new Date(a.date));
      let total = 0;
      sorted.forEach(exp => {
        total += exp.amount || 0;
        const div = document.createElement('div');
        div.innerHTML = `<strong>${exp.date}</strong> - ${exp.description}: <span style="color:red;">$${exp.amount.toFixed(2)}</span>`;
        expensesList.appendChild(div);
      });
      // Mostrar el total gastado abajo
      const totalDiv = document.createElement('div');
      totalDiv.style.fontWeight = 'bold';
      totalDiv.style.marginTop = '10px';
      totalDiv.innerHTML = `Total gastado en misceláneos: <span style="color:red;">$${total.toFixed(2)}</span>`;
      expensesList.appendChild(totalDiv);
    } else {
      expensesList.innerHTML = '<div>No hay gastos registrados.</div>';
    }
  });
}
// Solo llama una vez a las funciones:
updateFinances();
updateFinanceSummary();
loadMiscExpenses();
    window.editPart = async function (partId) {
  const partRef = ref(database, `inventory/${partId}`);
  onValue(partRef, (snapshot) => {
    const part = snapshot.val();
    if (part) {
      // Prompts para cantidad y precios
      const quantity = prompt('Nueva cantidad (agregar a la actual):', 0);
      const buyPrice = prompt('Nuevo precio de compra por pieza:', part.buyPrice);
      const sellPrice = prompt('Nuevo precio de venta por pieza:', part.sellPrice);

      // Preguntar si quiere cambiar la foto
      const changePhoto = prompt('¿Quieres cambiar la foto? Ingresa "s" para sí, o presiona Enter para no:');
      let photoBase64 = part.photo; // Mantener la foto actual por defecto

      if (changePhoto && changePhoto.toLowerCase() === 's') {
        return new Promise((resolve) => {
          // Crear un input temporal para la foto
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = 'image/*';

          input.onchange = async function (e) {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = async function (e) {
                const img = new Image();
                img.src = e.target.result;

                img.onload = async function () {
                  const maxSize = 300 * 1024; // 300 KB en bytes
                  const canvas = document.createElement('canvas');
                  const ctx = canvas.getContext('2d');

                  // Reducir dimensiones
                  let width = img.width;
                  let height = img.height;
                  const maxWidth = 800;
                  const maxHeight = 600;
                  if (width > height) {
                    if (width > maxWidth) {
                      height *= maxWidth / width;
                      width = maxWidth;
                    }
                  } else {
                    if (height > maxHeight) {
                      width *= maxHeight / height;
                      height = maxHeight;
                    }
                  }

                  canvas.width = width;
                  canvas.height = height;
                  ctx.drawImage(img, 0, 0, width, height);

                  // Comprimir
                  photoBase64 = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
                  const byteLength = atob(photoBase64).length;
                  if (byteLength > maxSize) {
                    document.getElementById('inventory-message').innerText = 'La imagen excede 300 KB. Intenta con una más pequeña.';
                    resolve(false);
                    return;
                  }

                  // Resolver con éxito
                  resolve(true);
                };

                img.onerror = function () {
                  document.getElementById('inventory-message').innerText = 'Error al procesar la imagen.';
                  resolve(false);
                };
              };
              reader.readAsDataURL(file);
            } else {
              resolve(false);
            }
          };

          // Agregar al DOM temporalmente y simular clic
          document.body.appendChild(input);
          input.click();

          // Limpiar el input después de usarlo
          input.onblur = () => document.body.removeChild(input);
        }).then((success) => {
          if (success) {
            // Actualizar la pieza con la nueva foto
            runTransaction(partRef, (currentPart) => {
              if (currentPart) {
                currentPart.quantity += parseInt(quantity) || 0;
                currentPart.buyPrice = parseFloat(buyPrice) || currentPart.buyPrice;
                currentPart.sellPrice = parseFloat(sellPrice) || currentPart.sellPrice;
                currentPart.photo = photoBase64;
                return currentPart;
              }
            }).then(() => {
              if (parseInt(quantity) > 0) {
                const today = new Date(Date.now() - (new Date()).getTimezoneOffset() * 60000).toISOString().split('T')[0];
                const financeRef = ref(database, `finances/${today}`);
                runTransaction(financeRef, (currentFinance) => {
                  const currentProfit = currentFinance?.profit || 0;
                  const additionalCost = parseFloat(buyPrice) * parseInt(quantity);
                  return { profit: currentProfit - additionalCost };
                });
              }
              document.getElementById('inventory-message').innerText = 'Pieza actualizada con éxito';
              loadInventory();
            }).catch(error => {
              document.getElementById('inventory-message').innerText = `Error al editar: ${error.message}`;
            });
          } else {
            document.getElementById('inventory-message').innerText = 'No se actualizó la foto.';
          }
        });
      } else {
        // Actualizar solo cantidad y precios si no cambia la foto
        runTransaction(partRef, (currentPart) => {
          if (currentPart) {
            currentPart.quantity += parseInt(quantity) || 0;
            currentPart.buyPrice = parseFloat(buyPrice) || currentPart.buyPrice;
            currentPart.sellPrice = parseFloat(sellPrice) || currentPart.sellPrice;
            return currentPart;
          }
        }).then(() => {
          if (parseInt(quantity) > 0) {
            const today = new Date(Date.now() - (new Date()).getTimezoneOffset() * 60000).toISOString().split('T')[0];
            const financeRef = ref(database, `finances/${today}`);
            runTransaction(financeRef, (currentFinance) => {
              const currentProfit = currentFinance?.profit || 0;
              const additionalCost = parseFloat(buyPrice) * parseInt(quantity);
              return { profit: currentProfit - additionalCost };
            });
          }
          document.getElementById('inventory-message').innerText = 'Pieza actualizada con éxito';
          loadInventory();
        }).catch(error => {
          document.getElementById('inventory-message').innerText = `Error al editar: ${error.message}`;
        });
      }
    }
  }, { onlyOnce: true });
};
  </script>
</body>
</html>
